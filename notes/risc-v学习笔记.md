# RISC-V

## RV32I

## RISC-V 汇编语言
    函数调用规范
        按需保存寄存器
    链接
        通常使用两条指令 lui addi   auipc jal
    
## RV32M

## RV32F RV32D
    使用单独的32个 F 寄存器

## 原子指令
    内存原子操作、加载保留|条件存储指令（不影响整数模块）

## 压缩指令
    每条短指令对应于一条标准的 RISC-V 指令
    只访问 10 个常用寄存器
    隐式写入源操作数的位置
    立即数被压缩

## 向量
    从内存中收集数据到向量寄存器中，流水线单元高效计算，分散的存回主存


## 特权架构
    权限模式
        机器模式（M）、监管者模式（S）、用户模式（U）
    机器模式
        hart 硬件线程
        拦截和处理异常（同步异常、异步中断）
        同步异常
            1. 访问错误异常 对物理内存地址进行了不支持的访问
            2. 断点异常
            3. 环境调用异常
            4. 非法指令异常
            5. 非对齐地址异常
        标准中断源：软件、时钟、外部来源
        M模式下必要的CSR寄存器：
            1. mtvec 保存发生异常时需要跳转的地址 （中断向量）
            2. mepc 指向发生异常时的指令
            3. mcause 指明异常类型
            4. mie 处理器能够处理和忽略的中断 （中断屏蔽字？？？）
            5. mip 目前正在准备处理的中断
            6. mtval 保存了陷入 trap 的附加信息
            7. mscratch 暂存一个字大小的数据
            8. mstatus 保存全局中断使能，以及其他信息
        hart 发生异常时，硬件自动经历的状态转换
            1. 异常指令的 pc 被保存在 mepc 中，pc 被设置为mtvec。
            2. 根据异常来源设置 mcause，并将 mtval 设置为出错的地址或者其他信息
            3. 把 mstatus 中的 mie 位清 0 禁用中断，并将先前的 mie 值保存在 mpie 中
            4. 把发生异常的权限模式保存在 mstatus 中的 mpp 域，再把权限模式改为 M 模式
        机器模式的中断程序处理过程
        1. 为避免覆盖整数寄存器中的内容，中断处理程序先在最开始用 mscratch 和整数寄存器（例如 a0）中的值交换。通常，软件会让 mscratch 包含指向附加临时内存空间的指针，处理程序用该指针来保存其主体中将会用到的整数寄存器。
        2. 在主体执行之后，中断程序会恢复它保存到内存中的寄存器，然后再次使用 mscratch 和 a0 交换，将两个寄存器恢复到它们在发生异常之前的值。
        3. 最后，处理程序用 mret 指令（M 模式特有的指令）返回。mret 将 PC 设置为 mepc，通过将 mstatus 的 MPIE 域复制到MIE 来恢复之前的中断使能设置，并将权限模式设置为 mstatus 的 MPP 域中的值。


    用户模式
        1. 在 U 模式下，尝试执行 M 模式指令或访问 CSR 的时候产生非法指令异常。
        2. 其它时候，U 模式和 M 模式的表现十分相似。通过将 mstatus.MPP 设置为 U，然后执行 mret指令，软件可以从 M 模式进入 U 模式。如果在 U 模式下发生异常，则把控制移交给 M 模式。
        3. 物理内存保护（PMP），只能访问自己的那部分内存

    监管者模式
        1. 使用基于页面的虚拟内存。这个功能构成了监管者模式（S 模式）的核心。
        2. 与 U 模式一样，S 模式下运行的软件不能使用 M 模式的 CSR 和指令，并且受到 PMP 的限制。
        3. 默认，所有异常都会由 M 模式下的异常处理程序处理，RISC-V 提供了一种异常委托机制。通过该机制可以选择性地将中断和同步异常交给 S 模式处理，而完全绕过 M 模式。mideleg 中记录了将哪些中断委托给 S 模式。medeleg 中记录了将哪些异常委托给 S 模式
        4. 委托给 S 模式的任何中断都可以被 S 模式的软件屏蔽。sie（Supervisor InterruptEnable，监管者中断使能）和 sip（Supervisor Interrupt Pending，监管者中断待处理）CSR是 S 模式的控制状态寄存器，他们是 mie 和 mip 的子集。它们有着和 M 模式下相同的布局，但在 sie 和 sip 中只有与由 mideleg 委托的中断对应的位才能读写。那些没有被委派的中断对应的位始终为零。
        5. S 模式的 CSR 同 M 模式，异常|中断处理过程同 M 模式
    
    基于页面的虚拟内存
        1. 访问未被映射的页或访问权限不足会导致页错误例外（page fault exception）
        2. 一个叫 satp（Supervisor Address Translation and Protection，监管者地址转换和保护）的 S 模式控制状态寄存器控制了分页系统。通常 M 模式的程序在第一次进入 S 模式之前会把零写入 satp 以禁用分页，然后 S 模式的程序在初始化页表以后会再次进行satp 寄存器的写操作。
        3. Sv32 地址转换同 x86 二级页表机制相似
        4. S 模式添加了 sfence.vma 指令来通知处理器，软件可能已经修改了页表，于是处理器可以相应地刷新 TLB。它需要两个可选的参数，这样可以缩小缓存刷新的范围。一个位于rs1，它指示了页表哪个虚址对应的转换被修改了；另一个位于 rs2，它给出了被修改页表的进程的地址空间标识符（ASID）。如果两者都是 x0，便会刷新整个转换缓存。



    